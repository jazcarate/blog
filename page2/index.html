<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-689SEV7MTT"></script>
    <script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-689SEV7MTT', { cookie_domain: 'blog.florius.com.ar', cookie_flags: 'SameSite=None;Secure' });</script>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" type="application/manifest+json; charset=utf-8" href="/site.webmanifest" />
    <meta name="robots" content="all">
    <meta name="author" content="florius">
    
    
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Florius‚Äô Blog" href="/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>2 / 3 | Florius‚Äô Blog | Joaquin ‚ÄòFlorius‚Äô Azcarate‚Äôs personal blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Florius‚Äô Blog" />
<meta name="author" content="Joaquin 'Florius' Azcarate" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Joaquin ‚ÄòFlorius‚Äô Azcarate‚Äôs personal blog" />
<meta property="og:description" content="Joaquin ‚ÄòFlorius‚Äô Azcarate‚Äôs personal blog" />
<link rel="canonical" href="https://blog.florius.com.ar/page2/" />
<meta property="og:url" content="https://blog.florius.com.ar/page2/" />
<meta property="og:site_name" content="Florius‚Äô Blog" />
<link rel="prev" href="https://blog.florius.com.ar/" />
<link rel="next" href="https://blog.florius.com.ar/page3" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Florius‚Äô Blog" />
<meta name="twitter:site" content="@FloriusWasTaken" />
<meta name="twitter:creator" content="@FloriusWasTaken" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joaquin 'Florius' Azcarate"},"description":"Joaquin ‚ÄòFlorius‚Äô Azcarate‚Äôs personal blog","url":"https://blog.florius.com.ar/page2/","@type":"WebPage","headline":"Florius‚Äô Blog","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202105052221" type="text/css">

    <!-- Fonts -->
    <link href="//fonts.googleapis.com/css?family=Karla|Montserrat&amp;display=swap" rel="stylesheet">
    
    <script src="//kit.fontawesome.com/88434a0a24.js" crossorigin="anonymous" async></script>
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Icons -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/ad1057-57c61c94a7ddf2ba989fac55a86fddc3525592f31c3bb5cc4d15c3dbb27bdc9532cea911826aa0ffa044d1384f305bc31a253f76f2e19a2f38319ebb50bc0e5f.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/03f085-afe2bc6d603074f1ff9728397b5bbab26dad3ad0f8229e622410a04d80d8bd1e31d8f9ac3e14d064d4c6b86e42380496110bf8536c8f3804b8911b4166fdbb03.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/7b553b-cd5095053eb2f2874f66b6f136c203a4a807c2acb4f39b2fb0fd75f9deaed5f3bc5161a486c705ea659a6b1de9aee01cd4c45a3f3058cc112a3c18bc0c468094.png"/>

    <meta name="theme-color" content="#000000">

    
</head>

<body class="site">
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="/" class="site-title">Florius‚Äô Blog</a>
      <nav class="site-nav">
        



    
    
    
    

    

    
    
    
    
        <a class="nav-link" href="/about/">About</a>
    

    

    
    
    
    
        <a class="nav-link" href="/categories/">Categories</a>
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/jazcarate"></a>
    
    
      <a class="fa fa-gitlab" href="https://gitlab.com/jazcarate"></a>
    
    
    
    
    
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:j@florius.com.ar"></a>
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/joaquin-azcarate"></a>
    
    
    <a class="fab fa-dev" href="https://dev.to/florius"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap animated fade-in-down" role="main">
      <div class="measure">
        

<div class="home">
  
    <div class="posts">
      
        <div class="post py3">
          <p class="post-meta">
	    
	      Dec 3, 2020
	    
	        </p>
          <a href="/xpost/2020/12/03/haskell-para-mentes-imperativas/" class="post-link"><h3 class="h1 post-title">Haskell para mentes imperativas</h3></a>
          <span class="post-summary">
            <p><em>El post original se puede leer en mi <a href="https://dev.to/florius/haskell-para-mentes-imperativas-4n7k">dev.to</a>.</em></p>

<p>Browseando YouTube encontr√© una playlist con un nombre muy interesante: ‚Äú<a href="https://www.youtube.com/watch?v=Vgu82wiiZ90&amp;list=PLe7Ei6viL6jGp1Rfu0dil1JH1SHk9bgDV">Haskell for Imperative Programmers</a>‚Äù en donde el autor Philipp Hagenlocher explica conceptos de Haskell en videos cortos, concisos, con varios ejemplos y hasta algunos ejercicios. Lo que me inspir√≥ a pensar c√≥mo podr√≠a aprender alguien que tiene ra√≠ces en un paradigma imperativo. Por suerte no tuve que usar mucho la imaginaci√≥n, ya que yo comenc√© con lenguajes imperativos, y en mi trabajo utilizo mayoritariamente el paradigma de objetos.</p>

<p>En este post quiero explorar algunas cosas que creo que me hubiesen servido para aprender Haskell. Teniendo una base en alg√∫n lenguaje imperativo, usar esta para programar en Haskell.</p>

<p>Si crees que entras en esta categor√≠a, contin√∫a leyendo.</p>

<h3 id="prefacio">Prefacio</h3>
<p>En este post har√© uso de analog√≠as y de patrones fuertemente asociados a la programaci√≥n imperativa, de tal forma que la carga para aclimatarse al nuevo paradigma sea la menor posible, pero no considero esta la mejora forma de programar de forma funcional. Mi razonamiento es que: usando nuestro conocimiento previo ayude a comenzar a escalar la pendiente que es aprender un paradigma nuevo, y que esto a su vez dispare nuevas e interesantes investigaciones.</p>

<h2 id="variables">Variables</h2>

<p>Veo muy com√∫nmente la cara de espanto cuando uno habla de un lenguaje, como Haskell, donde la inmutabilidad est√° por defecto. Prontamente surge la pregunta de ‚Äúc√≥mo puedo asignar una variable‚Äù o ‚Äúcomo puedo cambiar el valor de un contador‚Äù.
Recordemos que Haskell es un lenguaje de programaci√≥n <a href="https://es.wikipedia.org/wiki/Turing_completo">Turing completo</a>, as√≠ que no es que <em>no se pueda</em> hacer, solo que hay que reconocer  que hay diferentes formas de afrontar un problema.</p>

<p>En Haskell, el s√≠mbolo <code class="language-plaintext highlighter-rouge">=</code> no representa una asignaci√≥n, si no es m√°s pr√≥ximo a la idea matem√°tica del <code class="language-plaintext highlighter-rouge">=</code> donde lo leemos (e interpretamos) como que algo <strong>es</strong> otra cosa.</p>

<p>En un lenguaje imperativo <code class="language-plaintext highlighter-rouge">x = 3</code> lo leemos como ‚Äúasignamos el valor <code class="language-plaintext highlighter-rouge">3</code> a la variable <code class="language-plaintext highlighter-rouge">x</code>‚Äù, donde en un paradigma funcional, lo deber√≠amos interpretar como ‚Äú<code class="language-plaintext highlighter-rouge">x</code> <em>es</em> 3‚Äù. <code class="language-plaintext highlighter-rouge">x</code> no puede cambiar. <code class="language-plaintext highlighter-rouge">x</code> simplemente <em>es</em>.</p>

<p>Se que esta justificaci√≥n suele no quitar el pavor. Tras indagar m√°s a fondo, suelo descubrir que hay dos temas distintos (pero muy  sobrelapados en los lenguajes imperativos):</p>

<p>Ponerle nombre a algo ‚Äúintermedio‚Äù. Por ejemplo, si uno est√° escribiendo un m√©todo, y ve que hay una operaci√≥n que se repite dos veces, suele ser considerado una buena pr√°ctica extraer lo com√∫n a una ‚Äúvariable‚Äù y ponerle nombre. Por ejemplo, podr√≠amos empezar con un m√©todo:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Int</span> <span class="nf">foo</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Int</span><span class="o">&gt;</span> <span class="n">xs</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span><span class="o">(</span><span class="n">xs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">xs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>y luego refactorizar a algo como:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Int</span> <span class="nf">foo</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Int</span><span class="o">&gt;</span> <span class="n">xs</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Int</span> <span class="n">tama√±o</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
  <span class="k">if</span><span class="o">(</span><span class="n">tama√±o</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">tama√±o</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>En este acaso <code class="language-plaintext highlighter-rouge">tama√±o</code> si bien es una ‚Äúvariable‚Äù, su intenci√≥n no es variar en el contexto de la funci√≥n. Es tan com√∫n y √∫til poder aseverar sobre qu√© cosas no cambian, que en otros lenguajes existe la idea que las ‚Äúvariables‚Äù puedan ser constantes (vaya ox√≠moron). Como <code class="language-plaintext highlighter-rouge">const</code> en JavaScript y PHP, <code class="language-plaintext highlighter-rouge">val</code>/<code class="language-plaintext highlighter-rouge">var</code>en Kotlin, variables en may√∫sculas en Python o <code class="language-plaintext highlighter-rouge">final</code> en Java.</p>

<p>Lectores atentos pueden reconocer un potencial problema en esta refactorizaci√≥n, en donde no podemos asegurar 100% que el m√©todo <code class="language-plaintext highlighter-rouge">List::size()</code> no cambia la lista, y que invocarlo 2 veces como en el c√≥digo de ‚Äúantes‚Äù podr√≠a no ser igual al c√≥digo de ‚Äúdespues‚Äù en donde solo se invoca una vez. Dado que conocemos la sem√°ntica de <code class="language-plaintext highlighter-rouge">List::size()</code>, podemos descansar que no va a alterar la lista; pero a veces, por la naturaleza de la mutabilidad, esto lleva a problemas. Toda una categor√≠a de problemas que simplemente no pueden ocurrir en un mundo inmutable üòâ.</p>

<p>Esto mismo podr√≠amos lograr en Haskell con palabras reservadas como <code class="language-plaintext highlighter-rouge">let ‚Ä¶ in</code> o <code class="language-plaintext highlighter-rouge">where</code>.</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">foo</span> <span class="o">::</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">foo</span> <span class="n">xs</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">length</span> <span class="n">xs</span> <span class="kr">then</span>
         <span class="o">-</span><span class="mi">1</span>
       <span class="kr">else</span>
         <span class="n">length</span> <span class="n">xs</span></code></pre></figure>

<p>Y luego del refactor:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">foo</span> <span class="o">::</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">foo</span> <span class="n">xs</span> <span class="o">=</span>
   <span class="kr">let</span> <span class="n">tama</span><span class="err">√±</span><span class="n">o</span> <span class="o">=</span> <span class="n">length</span> <span class="n">xs</span>
   <span class="kr">in</span> <span class="kr">if</span> <span class="n">tama</span><span class="err">√±</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="kr">then</span>
         <span class="o">-</span><span class="mi">1</span>
       <span class="kr">else</span>
         <span class="n">tama</span><span class="err">√±</span><span class="n">o</span></code></pre></figure>

<p>o</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">foo</span> <span class="o">::</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">foo</span> <span class="n">xs</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">tama</span><span class="err">√±</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="kr">then</span>
         <span class="o">-</span><span class="mi">1</span>
       <span class="kr">else</span>
         <span class="n">tama</span><span class="err">√±</span><span class="n">o</span>
   <span class="kr">where</span> <span class="n">tama</span><span class="err">√±</span><span class="n">o</span> <span class="o">=</span> <span class="n">length</span> <span class="n">xs</span></code></pre></figure>

<p>Si bien hacen lo mismo, tienen sutiles diferencias a las entrar√© en detalle (pero si est√° aqu√≠: <a href="https://wiki.haskell.org/Let_vs._Where">Let vs. Where - HaskellWiki</a>).</p>

<h2 id="cosas-que-cambian">Cosas que cambian</h2>

<p>El otro <em>sabor</em> de variables, es el de algo que cambia; y aqu√≠, no tenemos suerte. No vamos a poder hacerlo. Pero eso no quita que podamos generar abstracciones para poder escribir algo que <em>se parezca</em>.</p>

<p>Pero antes de hablar de cosas que cambian, primero necesitamos estar de acuerdo en algunas convenciones. Cosas como</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">bar</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">x</span><span class="p">){</span>
    <span class="o">*</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>En donde una funci√≥n altera el valor que se le pasa son <em>el mal</em>, y no poder hacerlo es un <em>feature</em> (Aunque me encanta la idea de <a href="https://www.tweag.io/blog/2020-11-11-linear-dps/">Pure destination-passing style in Linear Haskell</a> cuando se apalanca del maravilloso sistema de tipos).</p>

<p>Algo mucho m√°s sensible ser√≠a una funci√≥n que tome el argumento y devuelva un nuevo n√∫mero, resultado de la suma del argumento y 4.</p>

<p>Pero no siempre es tan sencillo. A veces tenemos varias mutaciones encadenadas, o unas que dependen de otras; por lo que podemos aplicar este algoritmo mental:
Cada vez que fu√©semos a cambiar una variable, en realidad utilizaremos una nueva variable que sea el resultado del cambio, y de ahora en adelante, utilizar el nuevo nombre.</p>

<p>Por ejemplo, con la nueva herramienta de <code class="language-plaintext highlighter-rouge">let ‚Ä¶ in</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">buzz</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">n</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">%</span> <span class="mi">3</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span><span class="mi">2</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">5</span>
  <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">3</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">buzz</span> <span class="n">n</span> <span class="o">=</span>
  <span class="kr">let</span> 
       <span class="n">x0</span> <span class="o">=</span> <span class="n">n</span>
       <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">3</span>
       <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span>
       <span class="n">x3</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">+</span> <span class="mi">5</span>
  <span class="kt">In</span> <span class="n">x3</span> <span class="o">&gt;</span> <span class="mi">3</span></code></pre></figure>

<p>Si esta forma de escribir parece tediosa (lo es!), al final de la pr√≥xima secci√≥n volveremos sobre esto, pero todav√≠a tenemos algo que podemos hacer. Revisemos qu√© es lo que es tan inconveniente: nombrar los pasos intermedios (<code class="language-plaintext highlighter-rouge">x0 - x3</code>) ¬øPodemos no hacerlo?.</p>

<p>De esta forma nos acercamos a un patr√≥n muy com√∫n en funcional, en donde uno tiene funciones intermedias que toman un valor, y devuelven ‚Äúel nuevo‚Äù valor. Podemos concatenar estas operaciones (que hablan de cambios, no de variables).</p>

<p>Imaginemos el mismo ejemplo, pero vamos a re escribirlo en peque√±as funciones intermedias que cambien el valor.</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">buzz</span> <span class="n">n</span> <span class="o">=</span>
  <span class="kr">let</span> <span class="n">f0</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">3</span>
       <span class="n">f1</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
       <span class="n">f2</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">5</span>
       <span class="n">f3</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span>
      
       <span class="n">x0</span> <span class="o">=</span> <span class="n">n</span>
       <span class="n">x1</span> <span class="o">=</span> <span class="n">f0</span> <span class="n">x0</span>
       <span class="n">x2</span> <span class="o">=</span> <span class="n">f1</span> <span class="n">x1</span>
       <span class="n">x3</span> <span class="o">=</span> <span class="n">f2</span> <span class="n">x2</span>
  <span class="kt">In</span> <span class="n">f3</span> <span class="n">x3</span></code></pre></figure>

<p>Lamentablemente como es un ejemplo tan sint√©tico, los nombres de las funciones intermedias ser√°n malos; pero espero que puedan imaginarse que estas funciones sean cosas como <code class="language-plaintext highlighter-rouge">incrementarEdad</code>, <code class="language-plaintext highlighter-rouge">extraerDinero</code> u otro nombre m√°s cercano al dominio de lo que esten programando.</p>

<p>Por ello voy a cambiar levemente el ejemplo para tener algo que sea m√°s humanamente legible.</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">numeroValidador</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">3</span>
<span class="n">normalizarValidador</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">migrarCoeficiente</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">5</span>
<span class="n">esValido</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span>

<span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
       <span class="n">x0</span> <span class="o">=</span> <span class="n">numeroValidador</span> <span class="n">n</span>
       <span class="n">x1</span> <span class="o">=</span> <span class="n">normalizarValidador</span> <span class="n">x0</span>
       <span class="n">x2</span> <span class="o">=</span> <span class="n">migrarCoeficiente</span> <span class="n">x1</span>
  <span class="kt">In</span> <span class="n">esValido</span> <span class="n">x2</span></code></pre></figure>

<p>Ahora podemos intentar pensar sobre nuestra <code class="language-plaintext highlighter-rouge">tarjetaValida</code>, donde lo que tiene que pasar es, en orden:</p>

<ol>
  <li>Dado un n√∫mero pasado como par√°metro (<code class="language-plaintext highlighter-rouge">n</code>)</li>
  <li>Tomamos el n√∫mero validador (<code class="language-plaintext highlighter-rouge">x mod 3</code>)</li>
  <li>Lo normalizamos (<code class="language-plaintext highlighter-rouge">x + 2</code>)</li>
  <li>Migramos el coeficiente (<code class="language-plaintext highlighter-rouge">x + 5</code>)</li>
  <li>Y chequeamos que sea v√°lido (<code class="language-plaintext highlighter-rouge">x &gt; 3</code>)</li>
</ol>

<p>Probablemente todav√≠a no sea evidente, pero ahora podemos hacer un refactor de ‚Äúinline‚Äù en cada variable intermedia (<code class="language-plaintext highlighter-rouge">x0 - x3</code>). Empecemos con <code class="language-plaintext highlighter-rouge">x3</code> e iremos ineline-ando de a una</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
       <span class="n">x0</span> <span class="o">=</span> <span class="n">n</span>
       <span class="n">x1</span> <span class="o">=</span> <span class="n">numeroValidador</span> <span class="n">x0</span>
       <span class="n">x2</span> <span class="o">=</span> <span class="n">normalizarValidador</span> <span class="n">x1</span>
  <span class="kt">In</span> <span class="n">esValido</span> <span class="p">(</span><span class="n">migrarCoeficiente</span>  <span class="n">x1</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
       <span class="n">x0</span> <span class="o">=</span> <span class="n">n</span>
       <span class="n">x1</span> <span class="o">=</span> <span class="n">numeroValidador</span> <span class="n">x0</span>
  <span class="kt">In</span> <span class="n">esValido</span> <span class="p">(</span><span class="n">migrarCoeficiente</span>  <span class="p">(</span><span class="n">normalizarValidador</span>  <span class="n">x1</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
       <span class="n">x0</span> <span class="o">=</span> <span class="n">n</span>
  <span class="n">esValido</span>  <span class="p">(</span><span class="n">migrarCoeficiente</span> <span class="p">(</span><span class="n">normalizarValidador</span> <span class="p">(</span><span class="n">numeroValidador</span> <span class="n">x0</span><span class="p">)))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
  <span class="n">esValido</span>  <span class="p">(</span><span class="n">migrarCoeficiente</span> <span class="p">(</span><span class="n">normalizarValidador</span> <span class="p">(</span><span class="n">numeroValidador</span> <span class="n">n</span><span class="p">)))</span></code></pre></figure>

<p>Esto se parece mucho m√°s a la descripci√≥n funcional de <code class="language-plaintext highlighter-rouge">tarjetaValida</code>, pero est√° escrito ‚Äúal rev√©s‚Äù. Por razones como esta existen <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Function.html#v:-38-">combinadores como <code class="language-plaintext highlighter-rouge">&amp;</code></a>, donde hablando mal y pronto, √©ste es el operador de <em>aplicaci√≥n reversa</em>.</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
  <span class="n">n</span> <span class="o">&amp;</span>
  <span class="n">numeroValidador</span> <span class="o">&amp;</span>
  <span class="n">normalizarValidador</span> <span class="o">&amp;</span>
  <span class="n">migrarCoeficiente</span> <span class="o">&amp;</span>
  <span class="n">esValido</span></code></pre></figure>

<p>Es interesante notar como todas nuestras funciones de ‚Äúcambio‚Äù tienen la misma firma: <code class="language-plaintext highlighter-rouge">:: Int -&gt; Int</code>. De forma m√°s gen√©rica, son funciones que toman un valor de un tipo, y <em>devuelven</em> algo del mismo tipo.</p>

<h3 id="aplicaci√≥n-parcial">Aplicaci√≥n parcial</h3>
<p>Con el c√≥digo que tenemos hasta aqu√≠; podr√≠amos cambiarlo para que <code class="language-plaintext highlighter-rouge">migrarCoeficiente</code> no siempre sume 5, si no que pueda ser parametrizable por una letra.
Sabiendo que hay una funci√≥n que transforma una letra a un n√∫mero <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Char.html#v:ord"><code class="language-plaintext highlighter-rouge">ord :: Char -&gt; Int</code></a> 
Podr√≠amos cambiar <code class="language-plaintext highlighter-rouge">migrarCoeficiente</code> a:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">migrarCoeficiente</span> <span class="o">::</span> <span class="kt">Char</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">migrarCoeficiente</span> <span class="n">letra</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">ord</span> <span class="n">caracter</span><span class="p">)</span></code></pre></figure>

<p>Ahora nuestra <code class="language-plaintext highlighter-rouge">tarjetaValida</code> no sufre muchos cambios:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">tarjetaValida</span> <span class="n">n</span> <span class="o">=</span>
  <span class="n">n</span> <span class="o">&amp;</span>
  <span class="n">numeroValidador</span> <span class="o">&amp;</span>
  <span class="n">normalizarValidador</span> <span class="o">&amp;</span>
  <span class="n">migrarCoeficiente</span> <span class="sc">'f'</span> <span class="o">&amp;</span>
  <span class="n">esValido</span></code></pre></figure>

<p>Y eso fu√© gracias a <a href="http://aprendehaskell.es/content/OrdenSuperior.html">la currificaci√≥n</a> de todas las funciones en Haskell!</p>

<h3 id="a-veces">A veces</h3>

<p>Otro gran ‚Äúhack‚Äù que nos permite la mutabilidad, es la de cambiar el valor, pero solo seg√∫n un flujo de control. Algo como:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">qux</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">n</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">%</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="k">return</span> <span class="n">ret</span></code></pre></figure>

<p>En donde asignamos una variable que seg√∫n uno u otro flujo de control puede cambiar. Siempre podremos reescribir esto de forma inmutable. Por ejemplo</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">qux</span> <span class="n">n</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">n</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span> <span class="mi">10</span> <span class="kr">else</span> <span class="n">n</span></code></pre></figure>

<p>Interesante notar que necesitamos un <code class="language-plaintext highlighter-rouge">else</code> que ‚Äúdeje todo como estaba‚Äù, pues no podemos ‚Äúno hacer nada‚Äù en esta forma de escribirlo.</p>

<h2 id="monadas">Monadas</h2>

<p><em>(No pod√≠a ser un post de Haskell, y no mencionar a las monadas)</em></p>

<p>Una idea en la programaci√≥n imperativa muy arraigada es que uno escribe una l√≠nea debajo de la otra, y esto hace que se ejecuten en ese orden.
Tan arraigada que casi no se considera una decisi√≥n del lenguaje, pero lo es! Es una decisi√≥n de dise√±o, y una que en un paradigma funcional es f√°cil escaparse.</p>

<p>Pero a veces, queremos ordenar una secuencia de cosas. Recordemos el ejemplo anterior de <code class="language-plaintext highlighter-rouge">buz</code>. Hay una monada (y probablemente <a href="http://aprendehaskell.es/content/MasMonadas.html">miles de</a> <a href="https://gist.github.com/sdiehl/8d991a718f7a9c80f54b">tutoriales de</a> <a href="https://wiki.haskell.org/State_Monad">como</a> <a href="https://mmhaskell.com/monads/state">implementarla</a>) llamada ‚Äústate‚Äù que representa una forma de secuenciar operaciones, e ir mutando un valor. Por lo que uno podr√≠a escribir algo mucho m√°s parecido a la forma imperativa:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="cd">--            |----- Va a ir mutando un Int
</span>
<span class="c1">--            v   v- va a retornar un booleano
</span>
<span class="n">buz</span> <span class="o">::</span> <span class="kt">State</span> <span class="kt">Int</span> <span class="kt">Bool</span>
<span class="n">buz</span> <span class="o">=</span>
  <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">ret</span> <span class="o">-&gt;</span> <span class="n">set</span> <span class="p">(</span><span class="n">ret</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
  <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">ret</span> <span class="o">-&gt;</span> <span class="n">put</span> <span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
  <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">ret</span> <span class="o">-&gt;</span> <span class="n">set</span> <span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
  <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">ret</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span></code></pre></figure>

<p>Cada <code class="language-plaintext highlighter-rouge">ret</code> en este caso solo existe dentro del lambda <em>(todo lo que est√© entre <code class="language-plaintext highlighter-rouge">(\</code> y <code class="language-plaintext highlighter-rouge">)</code>)</em></p>

<p>Muchas veces se ven las monadas con el <a href="https://es.wikipedia.org/wiki/Az%C3%BAcar_sint%C3%A1ctico"><em>az√∫car sint√°ctico</em></a> de la notaci√≥n <code class="language-plaintext highlighter-rouge">do</code>, que lo hace muy conveniente porque nos deja, como en un paradigma imperativo, escribir una l√≠nea debajo de la otra.</p>

<h3 id="monadas-cont">Monadas Cont.</h3>
<p>Otra gran raz√≥n para implementar una secuencia de operaciones, es que estas puedan fallar. El fallo en cualquier rengl√≥n invalide toda la computaci√≥n. Pensemos en m√©todos que podr√≠an lanzar excepciones.
Para esto tambi√©n existe una monada! Y podr√≠amos escribir algo como:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">precio</span><span class="p">(</span><span class="n">itemConNombre</span> <span class="nv">nombre</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">item</span> <span class="o">=</span> <span class="n">inventario</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">Errores</span><span class="o">.</span><span class="nf">noExiste</span><span class="p">(</span><span class="nv">nombre</span><span class="p">:</span> <span class="n">nombre</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">guard</span> <span class="n">item</span><span class="o">.</span><span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">Errores</span><span class="o">.</span><span class="n">fueraDeStock</span>
        <span class="p">}</span>

        <span class="n">item</span><span class="o">.</span><span class="n">price</span>
<span class="p">}</span></code></pre></figure>

<p>De esta forma</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">data</span> <span class="kt">Errores</span> <span class="o">=</span> <span class="kt">FueraDeStock</span> <span class="o">|</span> <span class="kt">NoExiste</span> <span class="kt">String</span>

<span class="n">buscar</span> <span class="o">::</span> <span class="kt">Inventario</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Item</span>
<span class="n">buscar</span> <span class="o">=</span> <span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">precio</span> <span class="o">::</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Either</span> <span class="kt">Errores</span> <span class="kt">Int</span>
<span class="n">precio</span> <span class="n">nombre</span> <span class="o">=</span> <span class="kr">do</span>
    <span class="n">item</span> <span class="o">&lt;-</span> <span class="n">maybe</span> <span class="p">(</span><span class="kt">Left</span> <span class="p">(</span><span class="kt">NoExiste</span> <span class="n">nombre</span><span class="p">))</span> <span class="kt">Right</span> <span class="n">itemEncontrado</span> <span class="c1">-- (1)
</span>
    <span class="n">when</span> <span class="p">(</span><span class="n">cantidad</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="kt">Left</span> <span class="kt">FueraDeStock</span><span class="p">)</span>
    <span class="n">return</span> <span class="n">precio</span> <span class="n">item</span>
  <span class="kr">where</span>
    <span class="n">itemEncontrado</span> <span class="o">::</span> <span class="kt">Maybe</span> <span class="kt">Item</span>
    <span class="n">itemEncontrado</span> <span class="o">=</span> <span class="n">buscar</span> <span class="n">inventario</span> <span class="n">nombre</span></code></pre></figure>

<p>La idea de la funci√≥n <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#v:maybe"><code class="language-plaintext highlighter-rouge">maybe</code></a> es poder extraer el valor de un <code class="language-plaintext highlighter-rouge">Maybe</code> (algo que puede o no estar). En el caso de que pueda fallar, <em>devolveremos</em> un <code class="language-plaintext highlighter-rouge">Left</code> (recordemos, representar√≠a como lanzar una excepci√≥n), y en el caso que hubiese un <code class="language-plaintext highlighter-rouge">Item</code>, devolveremos un <code class="language-plaintext highlighter-rouge">Right</code>.</p>

<p>De esta forma, no <em>ejecutaremos</em> el <code class="language-plaintext highlighter-rouge">return</code> hasta que no pasen las dos condiciones anteriores.</p>

<h2 id="getter-y-setter">Getter y Setter</h2>

<p>Por √∫ltimo, quiero tocar algo de modelado, y la parte de lo que menos quiero escribir, porque es la que m√°s se separa del paradigma; pero no obstante puedo ver c√≥mo alguien puede estar tentado a utilizar herramientas de modelado de paradigmas que ya conoce, y pensar en un <a href="http://aprendehaskell.es/content/ClasesDeTipos.html"><em>record</em></a> es parecido a un objeto. Pero si as√≠ fuera‚Ä¶ donde ponemos los m√©todos de este objeto?! (Sin entrar en el mundo de <a href="https://hackage.haskell.org/package/lens"><code class="language-plaintext highlighter-rouge">lens</code></a>).
No voy a objetar (ü§≠) porque se que yo lo hice durante mucho tiempo, as√≠ que mientras que sepamos que hay <em>tela para cortar</em>, por ahora puedo vivir con que pensemos que son objetos.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">Point</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">edad</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>podr√≠amos escribirlo as√≠:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">data</span> <span class="kt">Persona</span> <span class="o">=</span> <span class="kt">Persona</span> <span class="p">{</span> <span class="n">edad</span> <span class="o">::</span> <span class="kt">Int</span> <span class="p">}</span></code></pre></figure>

<p>Y tendremos <em>gratis</em> la funci√≥n <code class="language-plaintext highlighter-rouge">edad :: Persona -&gt; Int</code> que ‚Äúsaca‚Äù la edad de una persona. Cual un getter, y la construcci√≥n:</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">cambiarEdad</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Persona</span> <span class="o">-&gt;</span> <span class="kt">Persona</span>
<span class="n">cambiarEdad</span> <span class="n">nuevaEdad</span> <span class="n">persona</span> <span class="o">=</span> <span class="n">persona</span> <span class="p">{</span> <span class="n">edad</span> <span class="o">=</span> <span class="n">nuevaEdad</span> <span class="p">}</span></code></pre></figure>

<p>Como un setter. Pero, como en OOP no estamos limitados a simplemente asignar el nuevo valor; podr√≠amos hacer lo que queramos!</p>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="n">cambiarEdad</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Persona</span> <span class="o">-&gt;</span> <span class="kt">Persona</span>
<span class="n">cambiarEdad</span> <span class="n">nuevaEdad</span> <span class="n">persona</span> <span class="o">=</span> <span class="n">persona</span> <span class="p">{</span> <span class="n">edad</span> <span class="o">=</span> <span class="n">nuevaEdad</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">}</span></code></pre></figure>

<p>Podemos encontrar un patr√≥n recurrente, donde tengamos funciones que <em>terminen</em> con el tipo: <code class="language-plaintext highlighter-rouge">foo :: ‚Ä¶ -&gt; Algo -&gt; Algo</code>. Si recordamos el ejemplo de <code class="language-plaintext highlighter-rouge">tarjetaValida</code>, todas las funciones intermedias que ten√≠amos eran del tipo: <code class="language-plaintext highlighter-rouge">:: Int -&gt; Int</code>, y el ejercicio al lector hubiera generado una funci√≥n con el tipo: <code class="language-plaintext highlighter-rouge">:: Char -&gt; Int -&gt; Int</code>. Podemos pensar en toda esta familia de funciones como funciones que ‚Äúalteran‚Äù. Adem√°s ahora ya sabemos c√≥mo combinarlas!
Por ejemplo, concatenar listas  <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/GHC-List.html#v:-43--43-"><code class="language-plaintext highlighter-rouge">(++) :: [a] -&gt; [a] -&gt; [a] </code></a> en donde toma una primera lista y una segunda, y las ‚Äúaltera‚Äù (recordando que en realidad lo que hace es <em>devolver</em> una nueva lista) o tomar los primeros <code class="language-plaintext highlighter-rouge">n</code> elementos (<a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/GHC-List.html#v:take"><code class="language-plaintext highlighter-rouge">take :: Int -&gt; [a] -&gt; [a]</code></a>). Hay much√≠simas funciones como estas, y probablemente escribamos tantas de estas como ‚Äúm√©todos‚Äù podr√≠an tener nuestros objetos, si lo modelamos en OOP.</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">Persona</span><span class="p">(</span><span class="kd">var</span> <span class="py">edad</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">var</span> <span class="py">altura</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">crecer</span><span class="p">(</span><span class="n">a√±os</span> <span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">this</span><span class="p">.</span><span class="n">edad</span> <span class="p">+=</span> <span class="n">a√±os</span>
                 <span class="k">this</span><span class="p">.</span><span class="n">altura</span> <span class="p">+=</span> <span class="n">a√±os</span><span class="p">*</span><span class="mi">2</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">data</span> <span class="kt">Persona</span> <span class="o">=</span> <span class="kt">Persona</span> <span class="p">{</span> <span class="n">edad</span> <span class="o">::</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">altura</span> <span class="o">::</span> <span class="kt">Int</span> <span class="p">}</span>

<span class="n">crecer</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Persona</span> <span class="o">-&gt;</span> <span class="kt">Persona</span>
<span class="n">crecer</span> <span class="n">a</span><span class="err">√±</span><span class="n">os</span> <span class="n">persona</span> <span class="o">=</span> <span class="kt">Persona</span> <span class="p">{</span> <span class="n">edad</span> <span class="o">=</span> <span class="n">edad</span> <span class="n">persona</span> <span class="o">+</span> <span class="n">a</span><span class="err">√±</span><span class="n">os</span><span class="p">,</span>  <span class="n">altura</span> <span class="o">=</span> <span class="n">altura</span> <span class="n">persona</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="err">√±</span><span class="n">os</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}</span></code></pre></figure>

<h2 id="fin">Fin</h2>
<p>Espero que con estas herramientas, el prospecto de programar en Haskell sea menos aterrorizador.</p>

          </span>
          
            <span class="related-categories">
            
              <a href="/categories#xpost">#xpost</a>
            
            </span>
          
        </div>
      
        <div class="post py3">
          <p class="post-meta">
	    
	      Sep 14, 2020
	    
	        </p>
          <a href="/xpost/2020/09/14/koncierge-una-libreria-para-segmentar-usuarios/" class="post-link"><h3 class="h1 post-title">koncierge Una librer√≠a para segmentar usuarios</h3></a>
          <span class="post-summary">
            <p><em>El post original se puede leer en mi <a href="https://dev.to/florius/koncierge-una-libreria-para-segmentar-usuarios-fjp">dev.to</a>.</em></p>

<h2 id="trasfondo">Trasfondo</h2>

<p>En donde estoy trabajando, cada nuevo feature o idea, pasa por un proceso de <em>A/B Testing</em>.
Normalmente lo que hacemos es:</p>

<ol>
  <li>Generamos una hip√≥tesis del estilo: ‚ÄúSi los usuarios tuviesen una notificaci√≥n cuando pasa <code class="language-plaintext highlighter-rouge">X</code>, entonces van a hacer <code class="language-plaintext highlighter-rouge">Y</code> m√°s seguido‚Äù.</li>
  <li>Desarrollamos esta notificaci√≥n, o lo que sea.</li>
  <li>Apuntamos a alg√∫n mercado para participar de esta prueba</li>
  <li>Dividimos a la mitad de los usuarios de ese mercado, tal que vean e interact√∫en con en nuevo feature, mientras que la otra mitad (grupo <em>control</em>) no.</li>
  <li>Esperamos dos semanas</li>
  <li>Comparamos las m√©tricas entre los dos grupos.</li>
</ol>

<p>Este √∫ltimo paso puede llevar a miles de ramificaciones: Activamos el feature para toda la poblaci√≥n. Cambiamos algo y volvemos a hacer una prueba. Lo deshabilitamos por completo porque nuestra hip√≥tesis era incorrecta. Etc, etc.</p>

<p>Para la segmentaci√≥n de la poblaci√≥n, estamos usando un servicio de un tercero. A este servicio, ocasionalmente le brindamos la informaci√≥n de segmentaci√≥n de nuestros usuarios.
Informaci√≥n como</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>El usuario `123` es de Madrid
</code></pre></div></div>

<p>para que luego, cuando queramos segmentar, podr√≠amos segmentar solo usuarios de Madrid.</p>

<p>Este servicio externo, adicionalmente, solo nos provee acceso a las variantes (si un usuario pertenece al segmento, es parte del grupo de control, o es parte del grupo que participa) mediante un SDK para usar en m√≥viles (iOS y Android).</p>

<p>Esto nos presentaba dos dificultades:</p>

<ol>
  <li>Si quisi√©ramos hacer un A/B Test en alguno de los micro-servicios de backend, no podr√≠amos consultar a este servicio.</li>
  <li>Si quisi√©ramos segmentar por algo de lo que no le hab√≠amos informado al servicio, deber√≠amos compartirle toda esta nueva informaci√≥n para que este pueda segmentar.</li>
</ol>

<p>Por esta situaci√≥n, decidimos crear un micro-servicio que se encargue de segmentar y separar en variantes a nuestros usuarios.</p>

<h2 id="problemas">Problemas</h2>

<p>R√°pidamente nos vimos enfrentados a resolver como hacer para obtener la informaci√≥n para segmentar.</p>

<p>Normalmente segmentamos por pa√≠s, lo que ser√≠a sencillo hacer que el nuevo micro-servicio consultara con otro micro-servicio de informaci√≥n; y obtuviese el pa√≠s del usuario.
Con esta nueva informaci√≥n, podr√≠amos segmentar.</p>

<p>Lo que presenta un desaf√≠o interesante:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Como evitar que este micro-servicio crezca
cada vez introduzcamos un nuevo micro-servicio que almacene
alguna informaci√≥n del usuario?
</code></pre></div></div>

<p>Por eso, pensamos que podr√≠amos delegar la responsabilidad de obtener el <em>contexto</em> del usuario, a quien consuma este micro-servicio; por lo que una llamada podr√≠a ser:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dado el usuario `123`, de Madrid;
a qu√© variante pertenece?
</code></pre></div></div>

<p>De esta manera, es quien consume quien necesita saber todas las dependencias del experimento, y cada experimento puede tener dependencias distintas, de distintas formas de computarse, y el micro-servicio podr√≠a no crecer.</p>

<h2 id="dsl-domain-specific-language---lenguaje-espec√≠fico-de-dominio">DSL (Domain-specific language - Lenguaje espec√≠fico de dominio)</h2>

<p>Ya sab√≠amos como querr√≠amos que se comporte el micro-servicio, ahora necesit√°bamos una forma de expresar como querr√≠amos segmentar nuestra poblaci√≥n. Hac√≠a poco estaba trabajando mucho con <a href="https://www.mongodb.com/"><code class="language-plaintext highlighter-rouge">Mongo</code></a> y se me ocurri√≥ que un lenguaje de consultas como el de mongo podr√≠a ser interesante de explorar.
De tal forma que una segmentaci√≥n como:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Quiero que solo participen del experimento `EXP001`,
usuarios quienes sean de Madrid.
De estos, la mitad estar√°n en el grupo de participando
y el esto en control.
</code></pre></div></div>

<p>Se transformar√≠a en:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"EXP001"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"ubicaci√≥n"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Madrid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"$children"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"participando"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$rand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$gt"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"control"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p><a href="https://koncierge-playground.herokuapp.com/?context=%7B%0A%20%20%20%20%22ubicaci%C3%B3n%22:%20%22Madrid%22,%0A%20%20%20%20%22userId%22:%205%0A%7D&amp;experiment=%7B%0A%20%20%20%20%22EXP001%22:%20%7B%0A%20%20%20%20%20%20%20%20%22ubicaci%C3%B3n%22:%20%22Madrid%22,%0A%20%20%20%20%20%20%20%20%22%24children%22:%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22participando%22:%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%24rand%22:%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%24gt%22:%200.5%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D,%0A%20%20%20%20%20%20%20%20%20%20%20%20%22control%22:%20%7B%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D">Playground</a></p>

<p>De esta manera, quien consuma al micro-servicio deber√≠a proveer, al menos, la informaci√≥n de la <code class="language-plaintext highlighter-rouge">"ubicaci√≥n"</code> del usuario.
Una posible consulta podr√≠a ser con el contexto:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"ubicaci√≥n"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Madrid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>El micro-servicio deber√≠a responder que pertenece al <code class="language-plaintext highlighter-rouge">EXP001</code> (dado que la ubicaci√≥n empareja con la definici√≥n), y podr√≠a pertenecer a la variante <code class="language-plaintext highlighter-rouge">participando</code> o <code class="language-plaintext highlighter-rouge">control</code>.
Los usuarios deber√≠an estar distribuidos 50%-50%; dado que hay un 50% de probabilidad que un numero al azar, uniformemente distribuido entre 0 y 1 (como es <code class="language-plaintext highlighter-rouge">$rand</code>) sea mayor a 0.5.</p>

<p>Con esta idea, sabiendo que la intenci√≥n era que el micro-servicio no dependiente de ninguna otra parte de arquitectura de nuestro ecosistema; se me ocurri√≥ que podr√≠a desarrollarlo como una librer√≠a p√∫blica; por si alguien m√°s tiene la necesidad que tuvimos nosotros.</p>

<h2 id="koncierge-">koncierge üõé</h2>

<p>La librer√≠a est√° en <a href="https://github.com/jazcarate/koncierge#readme">GitHub :: jazcarate/koncierge</a></p>

          </span>
          
            <span class="related-categories">
            
              <a href="/categories#xpost">#xpost</a>
            
            </span>
          
        </div>
      
        <div class="post py3">
          <p class="post-meta">
	    
	      Jul 10, 2019
	    
	        </p>
          <a href="/xpost/2019/07/10/the-essence-of-event-sourcing/" class="post-link"><h3 class="h1 post-title">The essence of Event Sourcing</h3></a>
          <span class="post-summary">
            <p><em>Original post can be found in the <a href="https://blog.10pines.com/2019/07/10/the-essence-of-event-sourcing/">10Pines blog</a>.</em></p>

<p>Event Sourcing is a somewhat trending topic, but by no accounts a new one. Right now you can find a lot of stories on how to event Source in Rust, Kafka or PostgreSQL, but I‚Äôve found a lack of high concept blog posts on what <strong>is</strong> event sourcing‚Ä¶ or rather, I‚Äôve found an overwhelming amount of supposedly event sourcing posts, all talking about a lot of different things (I‚Äôm looking at you CQRS).</p>

<script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/2431_RC04/embed_loader.js"></script>

<script type="text/javascript">trends.embed.renderExploreWidget("TIMESERIES", {"comparisonItem":[{"keyword":"Event Sourcing","geo":"","time":"today 5-y"}],"category":0,"property":""}, {"exploreQuery":"date=today%205-y&q=Event%20Sourcing","guestPath":"https://trends.google.com:443/trends/embed/"});</script>

<p>So, I‚Äôll throw my wrench in the works and try to explain what I see as ‚ÄúEvent Sourcing‚Äù, not by actually going into any technical details, but rather into how we solve a problem on that subject.</p>

<h2 id="backstory-sourcing-events">Backstory (Sourcing Events)</h2>

<p>We had a small internal app that we used in big meetings to serialize conversations. Think of it as an over-complicated, over-designed queue. The app had a backend and a frontend, both which shared the particular state that the app should show to the user.</p>

<p>Basically: Who was talking, and who comes next.</p>

<p>The app kept all of our smartphones in sync. Whenever someone, say Joe, pushed the ‚ÄúI want to talk next‚Äù button, the backend did all the computations to add him to the end of the queue, and all of our smartphones got the message with the new state to display. Joe was now on the queue. Waiting.</p>

<p>This was good enough for several meetings but we, as a tech savvy company, wanted more! So, of course, we added features like emoji support to üëç, üëé and ask that the speaker would wrap up (üåØ).</p>

<p>So far, no Events to be Sourced whatsoever.</p>

<p>After a new round of emoji-enhanced meetings, I wondered: How many üëç did I had when I spoke last week?</p>

<p>I had no way of knowing. The backend was <em>updating</em> the list of reactions every time a new speaker‚Äôs turn was up. And therein laid my problem. I never considered that after the meeting I might want to know something as simple as that.</p>

<p>So we put on our thinking hats and settled on a simple heuristic:</p>

<p><strong>No Updates. No Deletes.</strong></p>

<h2 id="the-actual-potato-eventing-source">The actual potato (Eventing Source)</h2>

<p>No Updates, no deletes might look like a daunting feat. How would we <a href="https://blog.10pines.com/2019/05/27/reifying-problems-in-our-software/">reflect reality</a> without the basic premise that <strong>things change</strong>. Luckily, we have functional programing close to our hearts here at 10Pines, and we can imagine a world where ‚Äúthings are immutable‚Äù.</p>

<p>So we had a frontend that was sending the intentions. What the user wanted to do. I will call this intentions <strong>Events</strong>.</p>

<p>We had 3 major events:</p>

<ul>
  <li>‚ÄúI want to talk‚Äù event.</li>
  <li>‚ÄúI don‚Äôt want to talk anymore‚Äù event</li>
  <li>‚ÄúI want to react with a üëç‚Äù event</li>
</ul>

<p>Notice this were not <em>‚ÄúAdd me to the queue‚Äù</em>, or <em>‚ÄúNow the speaker has 5 üëç‚Äù</em>, but rather the intention the user had.</p>

<p>Now, the backend had to receive these events, and instead of <strong>updating</strong> its state, saving it and broadcasting it; we were saving the event and computing a new state (based on the previous state and this new event)</p>

<table>
  <thead>
    <tr>
      <th>Previous state</th>
      <th>Event</th>
      <th>Current state</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{ currentSpeaker: Joaco, queue: [] }</code></td>
      <td>Dave wants to talk</td>
      <td><code class="language-plaintext highlighter-rouge">{ currentSpeaker: Joaco, queue: [Dave] }</code></td>
    </tr>
  </tbody>
</table>

<p>And, you guessed it: the previous state was <strong>itself</strong> computed with its previous state plus the last event before this new one. So on and so forth.</p>

<table>
  <thead>
    <tr>
      <th>Previous-previous state</th>
      <th>Event</th>
      <th>Previous state</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{ currentSpeaker: nil, queue: [] }</code></td>
      <td>Joaco wants to talk</td>
      <td><code class="language-plaintext highlighter-rouge">{ currentSpeaker: Joaco, queue: [] }</code></td>
    </tr>
  </tbody>
</table>

<p>We changed from a state that was being updated, to adding onto a list events, and finding out the new state computing every event and how they changed the state. No information can be lost. Ever. <strong>No updates. No deletes.</strong></p>

<h2 id="back-to-the-original-question-source-event">Back to the original question (Source Event)</h2>

<p>How many reactions did I have. Well, now I could figure this out. I just needed to replay all the events, but now, instead of having a state that had the whole queue, I‚Äôd use the events to transform a different, more useful state:</p>

<table>
  <thead>
    <tr>
      <th>A state</th>
      <th>Event</th>
      <th>New state</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{ reactions_joaco_had: 0 }</code></td>
      <td>Joaco wants to talk</td>
      <td><code class="language-plaintext highlighter-rouge">{ reactions_joaco_had: 0 }</code></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>A state</th>
      <th>Event</th>
      <th>New state</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">{ reactions_joaco_had: 0 }</code></td>
      <td>I want to react with a üëç</td>
      <td><code class="language-plaintext highlighter-rouge">{ reactions_joaco_had: 1 }</code></td>
    </tr>
  </tbody>
</table>

<p><em>*This is an oversimplification because we would still need to know who was talking at the time to know if we had to increment the reaction counter or not.</em></p>

<p>This is called a projection, and it is the way we can ‚Äúfold‚Äù our events into relevant information.</p>

<h2 id="lets-recap-evented-source">Lets recap (Evented Source)</h2>

<p>We changed the way we thought of our storage. Rather than update what we know, we add to an infinite list the events that change our domain.</p>

<p>This way, we can <em>replay</em> those events and answer questions we never thought we wanted to ask at the time of writing the code.</p>

<h2 id="food-for-thought">Food for thought:</h2>

<p>I wanted to keep this post short and high-concept; but I‚Äôll let the reader think of some interesting things that steam from this kind of approach:</p>

<ul>
  <li>If we ever botched the part of the system that computed new states; we could rollout a fixed version, and replay the whole history of the application, and the error would cease to exist.</li>
  <li>Structural changes to the database stop being something to worry about. We are only storing events, and those don‚Äôt change often. Rolling back and replaying the history is the fabric of event sourcing.</li>
  <li>The new state doesn‚Äôt need to be computed from the first initial state, along with all the events thereafter. We can periodically take ‚Äúsnapshots‚Äù of events, and compute newer events from that saved state.</li>
  <li>The same stream of events can be used by many applications, each having their own projection to answer a wildly different set of questions.</li>
</ul>


          </span>
          
            <span class="related-categories">
            
              <a href="/categories#xpost">#xpost</a>
            
            </span>
          
        </div>
      
    </div>

    
<div class="pagination clearfix mb1 mt4">
  <div class="left">
    
      
        <a class="pagination-item" href="/">Newer</a>
      
    
  </div>
  <div class="right">
    
      <a class="pagination-item" href="/page3">Older</a>
    
  </div>
  <div class="pagination-meta">Page 2 of 3</div>
</div>


  
</div>

      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme heavily inspired in <a href="http://johnotander.com">John Otander</a>' <a href="https://github.com/johno/pixyll">pixyll</a>.
    </small>
  </div>
</footer>
<!-- AnchorJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script>
    anchors.options.visible = 'touch';
    anchors.add('article h2, article h3, article h4, article h5, article h6');
</script>

</body>
</html>
